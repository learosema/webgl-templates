function convertArray(e,t=WebGLRenderingContext.FLOAT){if(t===WebGLRenderingContext.FLOAT)return new Float32Array(e);if(t===WebGLRenderingContext.BYTE)return new Uint8Array(e);throw Error("type not supported")}function shader(e,t){return r=>{const n=r.createShader(/frag/.test(t)?r.FRAGMENT_SHADER:r.VERTEX_SHADER);if(!n)throw Error("shader type not supported");if(r.shaderSource(n,e),r.compileShader(n),!r.getShaderParameter(n,r.COMPILE_STATUS))throw"Could not compile Shader.\n\n"+r.getShaderInfoLog(n);return n}}class GLea{constructor({canvas:e,gl:t,contextType:r="webgl",shaders:n,buffers:i,devicePixelRatio:a=1,glOptions:o}){if(this.canvas=document.createElement("canvas"),this.canvas=e||document.querySelector("canvas"),this.canvas||(this.canvas=document.createElement("canvas"),document.body.appendChild(this.canvas)),!document.querySelector("link[rel=stylesheet], style")){const e=document.createElement("style");e.innerHTML="body{margin:0}canvas{display:block;width:100vw;height:100vh}",document.head.appendChild(e)}this.gl=t||this.getContext(r,o);const s=this.gl.createProgram();if(!s)throw Error("gl.createProgram failed");this.program=s,this.buffers={},this.shaderFactory=n,this.bufferFactory=i||this.getDefaultBuffers(),this.textures=[],this.devicePixelRatio=a}getDefaultBuffers(){return{position:GLea.buffer(2,[1,1,-1,1,1,-1,-1,-1])}}getContext(e,t){if("webgl"===e)return this.canvas.getContext("webgl",t)||this.canvas.getContext("experimental-webgl",t);if("webgl2"===e)return this.canvas.getContext("webgl2",t);throw Error(`no ${e} context available.`)}static vertexShader(e){return t=>shader(e,"vert")(t)}static fragmentShader(e){return t=>shader(e,"frag")(t)}static buffer(e,t,r=WebGLRenderingContext.STATIC_DRAW,n=WebGLRenderingContext.FLOAT,i=!1,a=0,o=0){return(s,u,c)=>{const h=u.getAttribLocation(c,s);u.enableVertexAttribArray(h);const f=u.createBuffer(),g=t instanceof Array?convertArray(t,n):t;return u.bindBuffer(u.ARRAY_BUFFER,f),u.bufferData(u.ARRAY_BUFFER,g,r),u.vertexAttribPointer(h,e,n,i,a,o),{id:f,name:s,data:g,loc:h,type:n,size:e}}}create(){const{gl:e}=this,{program:t}=this;if(this.shaderFactory.map(t=>t(e)).map(r=>{e.attachShader(t,r)}),e.linkProgram(t),e.validateProgram(t),!e.getProgramParameter(t,e.LINK_STATUS)){throw"Could not compile WebGL program. \n\n"+e.getProgramInfoLog(t)}return this.use(),Object.keys(this.bufferFactory).forEach(r=>{const n=this.bufferFactory[r];this.buffers[r]=n(r,e,t)}),this.resize(),this}setActiveTexture(e,t){const{gl:r}=this;r.activeTexture(r.TEXTURE0+e),r.bindTexture(r.TEXTURE_2D,t)}createTexture(e=0,t={textureWrapS:"clampToEdge",textureWrapT:"clampToEdge",textureMinFilter:"nearest",textureMagFilter:"nearest"}){const r=(e="")=>/^[A-Z0-9_]+$/.test(e)?e:e.replace(/([A-Z])/g,"_$1").toUpperCase(),{gl:n}=this,i=n.createTexture();n.activeTexture(n.TEXTURE0+e),n.bindTexture(n.TEXTURE_2D,i);for(let e in t)if(t.hasOwnProperty(e)){const i=r(e),a=r(t[e]);i in n&&a in n&&n.texParameteri(n.TEXTURE_2D,n[i],n[a])}return this.textures.push(i),i}updateBuffer(e,t=0){const{gl:r}=this,n=this.buffers[e];r.bindBuffer(r.ARRAY_BUFFER,n.id),r.bufferSubData(r.ARRAY_BUFFER,t,n.data)}resize(){const{canvas:e,gl:t,devicePixelRatio:r}=this;e&&(e.width=e.clientWidth*r,e.height=e.clientHeight*r,t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight))}get width(){return this.canvas?this.canvas.width:NaN}get height(){return this.canvas?this.canvas.height:NaN}use(){return this.gl.useProgram(this.program),this}uniM(e,t){const{gl:r,program:n}=this,i=r.getUniformLocation(n,e);if(4===t.length)return r.uniformMatrix2fv(i,!1,t),i;if(9===t.length)return r.uniformMatrix3fv(i,!1,t),i;if(16===t.length)return r.uniformMatrix4fv(i,!1,t),i;throw Error("unsupported uniform matrix type")}uniV(e,t){const{gl:r,program:n}=this,i=r.getUniformLocation(n,e);if(2===t.length)return r.uniform2fv(i,t),i;if(3===t.length)return r.uniform3fv(i,t),i;if(4===t.length)return r.uniform4fv(i,t),i;throw Error("unsupported uniform vector type")}uniIV(e,t){const{gl:r,program:n}=this,i=r.getUniformLocation(n,e);if(2===t.length)return r.uniform2iv(i,t),i;if(3===t.length)return r.uniform3iv(i,t),i;if(4===t.length)return r.uniform4iv(i,t),i;throw Error("unsupported uniform vector type")}uni(e,t){const{gl:r,program:n}=this,i=r.getUniformLocation(n,e);return"number"==typeof t&&r.uniform1f(i,t),i}uniI(e,t){const{gl:r,program:n}=this,i=r.getUniformLocation(n,e);"number"==typeof t&&r.uniform1i(i,t)}clear(e=null){const{gl:t}=this;e&&t.clearColor(e[0],e[1],e[2],1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}destroy(){const{gl:e,program:t,canvas:r}=this;try{e.deleteProgram(t),Object.values(this.buffers).forEach(t=>{e.deleteBuffer(t.id)}),this.buffers={},this.textures.forEach(t=>{e.deleteTexture(t)}),this.textures=[],e.getExtension("WEBGL_lose_context").loseContext();const n=r.cloneNode();r.parentNode&&(r.parentNode.insertBefore(n,r),r.parentNode.removeChild(r)),this.canvas=n}catch(e){console.error(e)}}}export default GLea;
